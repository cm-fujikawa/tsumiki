---
description: システムの各レイヤーにおける包括的なエッジケース・エラー状態を詳細に分析し、見落としがちな異常系シナリオを洗い出します
allowed-tools: Read, Glob, Grep, Task, Write, Edit, TodoWrite, AskUserQuestion
argument-hint: [要件名]
---
システムの各レイヤーにおける包括的なエッジケース・エラー状態を分析します。アプリケーション・UI・データ・ネットワーク・非同期・認証などの各層で発生する複合的なエッジケースを詳細に洗い出します。

# context

出力ディレクトリ=".dcs"
カレントディレクトリ={{プロジェクトルート}}
分析モード="" # "requirements-based" or "source-based"
要件名="" # 要件定義書ベースの場合
分析対象="" # ソースコードベースの場合
収集情報={} # 要件定義書の内容 or ソースコードから収集した情報
分析ファイルリスト=[]
チェックリストパス="" # check_list.md のパス
既存チェックリスト=[] # 既に登録されているチェックリスト項目
調査段階=1
エッジケースカテゴリ=[
  "アプリケーション層ビジネスロジック",
  "UI状態",
  "データ管理層",
  "ネットワーク通信層",
  "非同期処理・メッセージング",
  "認証・認可",
  "エラーハンドリング",
  "データモデル状態組み合わせ",
  "複合的なエッジケース"
]

# step

- $1 がない場合、「引数に要件名または分析対象を指定してください（例: /tsumiki:dcs:kairo-edgecase-analysis ユーザー認証システム）」と言って終了する
- $1 の内容を context に保存する
- context の内容をユーザに宣言する
- step0 を実行する

## step0: 分析モードの判定

- 要件定義書の確認
  - `docs/spec/{$1}/requirements.md` が存在するか確認
  - 存在する場合:
    - 要件定義書ベースの分析を実施
    - context を更新:
      - 分析モード = "requirements-based"
      - 要件名 = $1
    - 「要件定義書「{{要件名}}」に基づいてエッジケース分析を実施します」と宣言
    - step1 を実行する（要件定義書ベースの分析）
  - 存在しない場合:
    - AskUserQuestion ツールを使って分析方法を質問する:
      - question: "要件定義書が見つかりません。どのように分析を進めますか?"
      - header: "分析方法"
      - multiSelect: false
      - options:
        - label: "ソースコードから分析（推奨）"
          description: "既存のソースコードを分析してエッジケースを特定します"
        - label: "要件定義書を作成してから分析"
          description: "先に要件定義書を作成し、その後エッジケース分析を実施します"
    - ユーザーの選択に応じて分岐:
      - "ソースコードから分析" を選択した場合:
        - ソースコードベースの分析を実施
        - context を更新:
          - 分析モード = "source-based"
          - 分析対象 = $1
        - step1-source を実行する（ソースコードベースの分析）
      - "要件定義書を作成してから分析" を選択した場合:
        - 「要件定義書の作成が必要です。先に `/tsumiki:kairo-requirements {要件名}` を実行してください」とメッセージを表示
        - 終了する

## step1: 要件情報の収集（要件定義書ベース）

- 要件定義書の確認
  - `docs/spec/{要件名}/requirements.md` を Read で読み込み
  - 読み込んだ内容を一時変数に保存

- 設計文書の確認
  - `docs/spec/{要件名}/design.md` が存在する場合は読み込み
  - `docs/design/` ディレクトリ内の関連設計文書を検索・読み込み
  - 読み込んだ内容を一時変数に保存

- タスクノートの確認
  - `docs/spec/{要件名}/note.md` が存在する場合は読み込み
  - 読み込んだ内容を一時変数に保存

- 既存のエッジケース分析の確認
  - {{出力ディレクトリ}}/{{timestamp}}_*_edgecase/ を検索
  - 既存の分析がある場合は最新のものを参照

- 収集した情報のサマリーを作成し、context の収集情報に保存
  - 要件の概要
  - 主要機能リスト
  - 既知の制約事項
  - 技術スタック
  - 要件定義書の内容
  - 設計文書の内容
  - タスクノートの内容

- step2 を実行する

## step1-source: ソースコードからの対象特定と情報収集

- ユーザーに分析内容を確認する
  - 「ソースコードから「{{分析対象}}」に関連するエッジケースを分析します」と宣言

- Task ツールで関連ファイル・情報の特定を実行する
  - subagent_type: "Explore"
  - model: "haiku"
  - description: "エッジケース分析対象の特定"
  - prompt: 以下の内容でエージェントに依頼
    ```
    「{{分析対象}}」に関連する以下の情報を収集してください：

    1. 関連するソースコードファイルの特定
       - メインロジック（ビジネスロジック、コントローラー、サービス等）
       - データモデル・スキーマ定義
       - API エンドポイント定義
       - UI コンポーネント（該当する場合）
       - テストコード
       - 設定ファイル

    2. 技術スタックの把握
       - 使用されているフレームワーク
       - ライブラリ・パッケージ
       - データベース・ストレージ
       - 外部API・サービス連携

    3. アーキテクチャパターンの理解
       - レイヤー構造
       - データフロー
       - エラーハンドリング方針
       - 非同期処理の有無
       - 認証・認可の仕組み

    4. 既存のエラーハンドリング状況
       - try-catch の使用箇所
       - バリデーションの実装
       - リトライ・フォールバック処理
       - ログ出力

    収集した情報を構造化してまとめてください。
    ```

- Explore エージェントの結果を受け取る

- 収集した情報のサマリーを作成し、context の収集情報に保存
  - 分析対象の概要
  - 関連ファイルリスト（相対パスで記載）
  - 技術スタック
  - アーキテクチャパターン
  - データフロー
  - 既存のエラーハンドリング状況
  - 非同期処理の実装状況
  - 認証・認可の仕組み

- ユーザーに収集結果を報告し、続行確認を得る
  - 「以下の情報を収集しました。この内容でエッジケース分析を続行しますか？」
  - サマリーを表示（主要なファイル、技術スタック、識別されたリスク領域など）

- step2 を実行する

## step2: 分析スコープの決定

- AskUserQuestion ツールを使って分析スコープを質問する：
  - question: "エッジケース分析のスコープを選択してください"
  - header: "分析スコープ"
  - multiSelect: false
  - options:
    - label: "包括的分析（推奨）"
      description: "全レイヤーのエッジケースを網羅的に分析。発生可能性・影響度を詳細評価"
    - label: "重点分析"
      description: "主要レイヤーのみ分析。Must Have要件に集中"
    - label: "カスタム"
      description: "分析対象レイヤーを個別に選択"

- ユーザーの選択を context に保存

- カスタムを選択した場合は、AskUserQuestion ツールを使って分析対象レイヤーを質問：
  - question: "分析対象のレイヤーを選択してください（複数選択可）"
  - header: "対象レイヤー"
  - multiSelect: true
  - options:
    - label: "アプリケーション層"
      description: "ビジネスロジックの状態遷移・バリデーション"
    - label: "UI層"
      description: "画面状態・ユーザー操作の組み合わせ"
    - label: "データ管理層"
      description: "トランザクション・同期・キャッシュ"
    - label: "ネットワーク通信層"
      description: "HTTPエラー・タイムアウト・リトライ"
    - label: "非同期処理層"
      description: "ジョブキュー・ワークフロー・並行処理"
    - label: "認証・認可層"
      description: "セッション・権限・トークン"
    - label: "複合的エッジケース"
      description: "複数レイヤーにまたがる複雑なケース"

- step3 を実行する

## step3: 初期分析の実行とチェックリスト初期化

- 出力ディレクトリの決定
  - Bash ツールで現在のタイムスタンプを取得する
    - `date +%Y%m%d%H%M%S` で yyyyMMddHHmmss 形式のタイムスタンプを取得
  - {{出力ディレクトリ}}/{{timestamp}}_*/ を検索して既存の分析を確認
  - 分析対象を英語化する
    - 要件定義書ベースの場合: 要件名を英語化（例: "user_auth_edgecase"）
    - ソースコードベースの場合: 分析対象を英語化（例: "task_manager_edgecase"）
  - **カレントディレクトリからの相対パスとして**ベースディレクトリを決定する
    - 相対パス形式: "{{出力ディレクトリ}}/{{timestamp}}_{{英語化名}}_edgecase"
    - 例: ".dcs/20251219103045_user_auth_edgecase"
  - **絶対パスは使用しない**（例: `/Users/kuroeda.makoto/projects/ensemble/.dcs/...` のような形式は使わない）

- チェックリストファイルのパス設定
  - チェックリストパス = "{{ベースディレクトリ}}/check_list.md" （相対パス）

- 既存チェックリストの読み込み（オプション）
  - ユーザーが他のチェックリストファイルを指定している場合、Read で読み込む
  - 読み込んだチェックリスト項目を 既存チェックリスト に追加
  - 形式: "- [ ] P0 説明 [リンク](path)"

- 分析結果ファイルのリストを準備する（すべて相対パスで記述）
  - インデックスファイル: "{{ベースディレクトリ}}/index.md"
  - チェックリストファイル: "{{ベースディレクトリ}}/check_list.md"
  - 初期分析ファイル: "{{ベースディレクトリ}}/initial_analysis.md"
  - レイヤー別分析ファイル（500行超過時は枝番付き）:
    - "{{ベースディレクトリ}}/layer_analysis_app.md" (アプリケーション層)
    - "{{ベースディレクトリ}}/layer_analysis_ui.md" (UI層)
    - "{{ベースディレクトリ}}/layer_analysis_data.md" (データ管理層)
    - "{{ベースディレクトリ}}/layer_analysis_network.md" (ネットワーク通信層)
    - "{{ベースディレクトリ}}/layer_analysis_async.md" (非同期処理層)
    - "{{ベースディレクトリ}}/layer_analysis_auth.md" (認証・認可層)
    - "{{ベースディレクトリ}}/layer_analysis_summary.md" (サマリー)
  - 複合分析ファイル（500行超過時は枝番付き）:
    - "{{ベースディレクトリ}}/combined_analysis_data_state.md" (データモデル状態組み合わせ)
    - "{{ベースディレクトリ}}/combined_analysis_multi_layer.md" (複数レイヤー)
    - "{{ベースディレクトリ}}/combined_analysis_cascade.md" (カスケード障害)
    - "{{ベースディレクトリ}}/combined_analysis_timing.md" (タイミング依存)
    - "{{ベースディレクトリ}}/combined_analysis_summary.md" (サマリー)
  - 最終レポートファイル: "{{ベースディレクトリ}}/final_report.md"

- すべてのファイル名を 分析ファイルリスト に追加する

- **ベースディレクトリを作成する**
  - Bash ツールで `mkdir -p {{ベースディレクトリ}}` を実行して、ベースディレクトリを作成する
  - 例: `mkdir -p .dcs/20251219103045_user_auth_edgecase`

- チェックリストファイルの初期化
  - Write ツールで "{{ベースディレクトリ}}/check_list.md" を作成（**相対パスを使用**）
  - 内容:
    ```markdown
    # エッジケース分析チェックリスト

    **分析対象**: {{分析対象名}}
    **分析モード**: {{分析モード}}
    **実施日時**: {{実施日時}}

    ---

    ## P0: 即座に対応が必要

    ## P1: 早急に対応

    ## P2: 計画的に対応

    ## P3: 監視

    ---

    *このチェックリストは分析の進行に伴い自動更新されます*
    ```

- <initial_analysis_template> の内容を context の情報で埋めて、Task ツールで実行する
  - subagent_type: "general-purpose"
  - model: "opus"
  - description: "エッジケース初期分析の実行"
  - prompt: テンプレートの内容を以下のように埋めた完全なプロンプト
    - **{{ベースディレクトリ}}**: カレントディレクトリからの相対パス（例: ".dcs/20251219103045_user_auth_edgecase"）
    - **{{カレントディレクトリ}}**: プロジェクトルートの絶対パス
    - 分析モードが "requirements-based" の場合:
      - {{分析対象名}} → {{要件名}}
      - {{収集済み情報}} → {{収集情報}}（要件定義書、設計文書、タスクノート）
      - {{分析モード}} → "requirements-based"
    - 分析モードが "source-based" の場合:
      - {{分析対象名}} → {{分析対象}}
      - {{収集済み情報}} → {{収集情報}}（ソースコードから収集した情報）
      - {{分析モード}} → "source-based"
    - **重要**: ファイルパスは必ず相対パスで記述すること

- Task の実行結果を受け取る
- step4 を実行する

## step4: レイヤー別エッジケース分析の並列実行

- 初期分析結果を Read で確認する

- ユーザに分析状況を報告し、続行確認を得る
  - 「6つのレイヤー（アプリケーション、UI、データ管理、ネットワーク、非同期、認証）を並列分析します」

- レイヤー別分析を並列実行する（**重要: 1つのメッセージで6つのTask toolを並列実行**）
  - 各レイヤーごとに Task ツールを使用:
    1. アプリケーション層: layer_analysis_app.md
       - subagent_type: "general-purpose"
       - model: "opus"
       - description: "アプリケーション層エッジケース分析"
       - prompt: <layer_analysis_app_template> の内容
    2. UI層: layer_analysis_ui.md
       - subagent_type: "general-purpose"
       - model: "opus"
       - description: "UI層エッジケース分析"
       - prompt: <layer_analysis_ui_template> の内容
    3. データ管理層: layer_analysis_data.md
       - subagent_type: "general-purpose"
       - model: "opus"
       - description: "データ管理層エッジケース分析"
       - prompt: <layer_analysis_data_template> の内容
    4. ネットワーク通信層: layer_analysis_network.md
       - subagent_type: "general-purpose"
       - model: "opus"
       - description: "ネットワーク通信層エッジケース分析"
       - prompt: <layer_analysis_network_template> の内容
    5. 非同期処理層: layer_analysis_async.md
       - subagent_type: "general-purpose"
       - model: "opus"
       - description: "非同期処理層エッジケース分析"
       - prompt: <layer_analysis_async_template> の内容
    6. 認証・認可層: layer_analysis_auth.md
       - subagent_type: "general-purpose"
       - model: "opus"
       - description: "認証・認可層エッジケース分析"
       - prompt: <layer_analysis_auth_template> の内容

- 各Taskの実行結果を受け取る

- すべてのレイヤー別分析ファイルが作成されたことを確認
  - Read で各ファイルの存在確認

- チェックリストの更新
  - 各レイヤー分析結果からチェックリスト項目を抽出
  - 既存チェックリスト と重複チェック（同じ内容の項目は追加しない）
  - 重複していない項目のみを check_list.md に追加
  - Edit ツールで check_list.md を更新
  - フォーマット: "- [ ] P0/P1/P2/P3 説明 [ファイル名](./layer_analysis_*.md#anchor)"

- レイヤー別サマリーを作成
  - Task ツールで layer_analysis_summary.md を生成
  - subagent_type: "general-purpose"
  - model: "opus"
  - description: "レイヤー別分析サマリー作成"
  - 全レイヤーの統計情報を集約

- step5 を実行する

## step5: 複合エッジケース分析の並列実行

- レイヤー別分析結果をすべて Read で確認する
  - layer_analysis_*.md のすべてのファイルを読み込む

- ユーザに分析状況を報告し、続行確認を得る
  - 「4つのカテゴリ（データモデル状態、複数レイヤー、カスケード障害、タイミング依存）を並列分析します」

- 複合エッジケース分析を並列実行する（**重要: 1つのメッセージで4つのTask toolを並列実行**）
  - 各カテゴリごとに Task ツールを使用:
    1. データモデル状態組み合わせ: combined_analysis_data_state.md
       - subagent_type: "general-purpose"
       - model: "opus"
       - description: "データモデル状態組み合わせ分析"
       - prompt: <combined_analysis_data_state_template> の内容
    2. 複数レイヤーにまたがるケース: combined_analysis_multi_layer.md
       - subagent_type: "general-purpose"
       - model: "opus"
       - description: "複数レイヤーエッジケース分析"
       - prompt: <combined_analysis_multi_layer_template> の内容
    3. カスケード障害: combined_analysis_cascade.md
       - subagent_type: "general-purpose"
       - model: "opus"
       - description: "カスケード障害分析"
       - prompt: <combined_analysis_cascade_template> の内容
    4. タイミング依存の問題: combined_analysis_timing.md
       - subagent_type: "general-purpose"
       - model: "opus"
       - description: "タイミング依存問題分析"
       - prompt: <combined_analysis_timing_template> の内容

- 各Taskの実行結果を受け取る

- すべての複合分析ファイルが作成されたことを確認
  - Read で各ファイルの存在確認

- チェックリストの更新
  - 各複合分析結果からチェックリスト項目を抽出
  - 既存チェックリスト と重複チェック（同じ内容の項目は追加しない）
  - 重複していない項目のみを check_list.md に追加
  - Edit ツールで check_list.md を更新
  - フォーマット: "- [ ] P0/P1/P2/P3 説明 [ファイル名](./combined_analysis_*.md#anchor)"

- 複合分析サマリーを作成
  - Task ツールで combined_analysis_summary.md を生成
  - subagent_type: "general-purpose"
  - model: "opus"
  - description: "複合分析サマリー作成"
  - 全カテゴリの統計情報を集約

- step6 を実行する

## step6: 最終レポートの作成と完了報告

- すべての分析結果ファイルを Read で確認する
  - initial_analysis.md
  - layer_analysis_*.md （全6レイヤー + サマリー）
  - combined_analysis_*.md （全4カテゴリ + サマリー）
  - check_list.md

- 最終レポートを Task ツールで作成
  - subagent_type: "general-purpose"
  - model: "opus"
  - description: "エッジケース分析 最終レポート作成"
  - prompt: <final_report_template> の内容を context で埋めた完全なプロンプト
  - 最終レポートファイル名: "{{ベースディレクトリ}}/final_report.md"
  - 重要な指示:
    - 500行以内に収めること
    - すべての分析結果へのリンクを含めること
    - check_list.md へのリンクを含めること

- index.md を更新する
  - Edit ツールで index.md を更新
  - すべての分析ファイルへのリンクを含める
  - check_list.md へのリンクを追加
  - 分析結果のサマリーを追加
  - 枝番ファイルがある場合は、すべてのファイルへのリンクを記載

- check_list.md の最終確認
  - Read で check_list.md を確認
  - P0/P1/P2/P3 ごとの項目数をカウント
  - 重複がないことを確認

- 全ての分析ファイルのパスを段階別に整理して表示する
  - チェックリスト: check_list.md
  - 初期分析ファイル: initial_analysis.md
  - レイヤー別分析ファイル（6レイヤー + サマリー）:
    - layer_analysis_app.md （枝番ファイルがある場合は _1.md, _2.md... も表示）
    - layer_analysis_ui.md
    - layer_analysis_data.md
    - layer_analysis_network.md
    - layer_analysis_async.md
    - layer_analysis_auth.md
    - layer_analysis_summary.md
  - 複合分析ファイル（4カテゴリ + サマリー）:
    - combined_analysis_data_state.md （枝番ファイルがある場合は表示）
    - combined_analysis_multi_layer.md
    - combined_analysis_cascade.md
    - combined_analysis_timing.md
    - combined_analysis_summary.md
  - 最終レポート: final_report.md
  - インデックス: index.md

- エッジケース分析完了をユーザに報告する
  - 発見されたエッジケースの総数
  - レイヤー別の内訳
  - 複合エッジケースの内訳
  - 高リスク（影響度:高 かつ 発生可能性:中以上）のケース数
  - チェックリスト項目数（P0/P1/P2/P3 別）
  - 推奨される対応優先順位
  - 出力されたファイル数
  - check_list.md のパスを強調表示

# rules

## ファイル名のルール

### timestamp の形式
- yyyyMMddHHmmss 形式（例: 20251219103045）

### 要件名の英語化のルール
- 要件名を簡潔な英語に変換する
- スネークケース（snake_case）を使用
- 最大30文字程度に収める
- "_edgecase" サフィックスを付ける
- 例:
  - "ユーザー認証システム" → "user_auth_edgecase"
  - "決済フロー" → "payment_flow_edgecase"
  - "データ同期機能" → "data_sync_edgecase"

### セクション別ファイル名のルール
- 分析結果は段階ごとに分割し、各ファイル500行以内を目標とする
- **500行を超える場合は枝番（_1, _2, _3...）をつけてさらに分割する**
- 枝番ファイルのルール:
  - ベース名に `_数字` を付ける（例: `layer_analysis_app_1.md`, `layer_analysis_app_2.md`）
  - 各枝番ファイルも500行以内に収める
  - 各枝番ファイルの最後に、次のファイルへのリンクを記載する
  - サマリーファイルには、すべての枝番ファイルへのリンクを含める
- ファイル一覧:
  - `index.md` - インデックス（全体概要とファイル一覧）
  - `initial_analysis.md` - 初期分析結果（超過時: initial_analysis_1.md, _2.md...）
  - レイヤー別エッジケース分析（レイヤーごとに分割、500行超過時は枝番付き）:
    - `layer_analysis_app.md` - アプリケーション層（超過時: _1.md, _2.md, _3.md...）
    - `layer_analysis_ui.md` - UI層（超過時: _1.md, _2.md...）
    - `layer_analysis_data.md` - データ管理層（超過時: _1.md, _2.md...）
    - `layer_analysis_network.md` - ネットワーク通信層（超過時: _1.md, _2.md...）
    - `layer_analysis_async.md` - 非同期処理層（超過時: _1.md, _2.md...）
    - `layer_analysis_auth.md` - 認証・認可層（超過時: _1.md, _2.md...）
    - `layer_analysis_summary.md` - レイヤー別分析サマリー
  - 複合エッジケース分析（カテゴリごとに分割、500行超過時は枝番付き）:
    - `combined_analysis_data_state.md` - データモデル状態組み合わせ（超過時: _1.md, _2.md...）
    - `combined_analysis_multi_layer.md` - 複数レイヤーにまたがるケース（超過時: _1.md, _2.md...）
    - `combined_analysis_cascade.md` - カスケード障害（超過時: _1.md, _2.md...）
    - `combined_analysis_timing.md` - タイミング依存の問題（超過時: _1.md, _2.md...）
    - `combined_analysis_summary.md` - 複合分析サマリー
  - `final_report.md` - 最終レポート（500行以内）

### 完全なファイル名の例
- `.dcs/20251219103045_user_auth_edgecase/index.md`
- `.dcs/20251219103045_user_auth_edgecase/initial_analysis.md`
- `.dcs/20251219103045_user_auth_edgecase/layer_analysis_app_1.md`（500行超過のため枝番付き）
- `.dcs/20251219103045_user_auth_edgecase/layer_analysis_app_2.md`
- `.dcs/20251219103045_user_auth_edgecase/layer_analysis_app_3.md`
- `.dcs/20251219103045_user_auth_edgecase/layer_analysis_ui.md`（500行以内）
- （以下、各レイヤーのファイル）
- `.dcs/20251219103045_user_auth_edgecase/combined_analysis_data_state_1.md`（500行超過のため枝番付き）
- `.dcs/20251219103045_user_auth_edgecase/combined_analysis_data_state_2.md`
- （以下、各複合分析のファイル）
- `.dcs/20251219103045_user_auth_edgecase/final_report.md`

## ファイルパスの記載ルール

- **カレントディレクトリを基準とした相対パスを使用する**
- フルパス（絶対パス）は記載しない
- カレントディレクトリは分析開始時の作業ディレクトリ
- すべてのファイルパスは相対パスで統一する
- 例:
  - ❌ `/Users/username/projects/app/src/utils/helper.ts`
  - ✅ `src/utils/helper.ts`
  - ❌ `/Users/kuroeda.makoto/projects/ensemble/.dcs/20251219103045_user_auth_edgecase/index.md`
  - ✅ `.dcs/20251219103045_user_auth_edgecase/index.md`

## エッジケース分析の観点

### アプリケーション層（ビジネスロジック）
- 状態遷移の異常パターン
- ビジネスルールの境界値・例外
- バリデーションエラーの組み合わせ
- 並行実行時の整合性
- タイミング依存の問題

### UI層
- 画面状態の不整合
- ユーザー操作の予期しないシーケンス
- 複数画面間の状態遷移
- 入力値の境界値・特殊文字
- デバイス・ブラウザ固有の問題
- オフライン・オンライン切替時の挙動

### データ管理層
- トランザクション失敗・ロールバック
- デッドロック・競合
- データ同期の不整合
- キャッシュの不一致
- データベース接続エラー
- データ移行時の問題
- バックアップ・リストア時の問題

### ネットワーク通信層
- HTTPステータスコード（4xx, 5xx）
- タイムアウト（接続・読み取り・書き込み）
- リトライ回数超過
- ネットワーク分断（パーティション）
- レート制限
- プロキシ・ファイアウォールの影響
- DNS解決失敗

### 非同期処理・メッセージング
- ジョブキューの失敗・リトライ
- ワークフローの中断・再開
- メッセージの順序不整合
- メッセージ重複処理
- デッドレター処理
- 並行実行時の競合

### 認証・認可層
- セッションタイムアウト
- トークン有効期限切れ
- 権限不足・権限昇格
- 多重ログイン
- ログアウト失敗
- パスワードリセット中の操作
- 二段階認証失敗

### エラーハンドリング
- 未キャッチ例外
- エラーメッセージの不適切な露出
- エラーログの欠落
- リカバリー処理の失敗
- エラー通知の失敗

### データモデル状態の組み合わせ
- 複数エンティティの状態組み合わせ
- マスタデータとトランザクションデータの不整合
- 論理削除と物理削除の混在
- バージョニングの問題
- 親子関係の整合性

### 複合的なエッジケース
- 複数レイヤーにまたがる障害
- カスケード障害
- タイムゾーン・ロケールの問題
- パフォーマンス劣化時の挙動
- リソース枯渇（メモリ・ディスク・CPU）
- システムメンテナンス中の操作

## エッジケース評価基準

### 発生可能性
- **高**: 日常的に発生しうる（週次・月次レベル）
- **中**: 稀に発生する（四半期・年次レベル）
- **低**: 極めて稀（複数年に1回程度）

### 影響度
- **高**: サービス停止・データ損失・セキュリティ侵害
- **中**: 機能制限・ユーザー体験悪化・一時的な不整合
- **低**: 軽微な不便・ログ出力・監視アラート

### リスクレベル（発生可能性 × 影響度）
- **クリティカル**: 高×高
- **高**: 高×中、中×高
- **中**: 高×低、中×中、低×高
- **低**: 中×低、低×中、低×低

## 推奨対応優先度

### P0（即座に対応）
- リスクレベル: クリティカル
- 影響度: 高
- 対応方針: 実装前に必ず対処

### P1（早急に対応）
- リスクレベル: 高
- 影響度: 中以上
- 対応方針: 初期リリースに含める

### P2（計画的に対応）
- リスクレベル: 中
- 影響度: 中以下
- 対応方針: 次期バージョンで対応

### P3（監視）
- リスクレベス: 低
- 影響度: 低
- 対応方針: ログ・監視で検知、必要に応じて対応

## エッジケース記載の品質基準

### 確度評価の基準（⭐ 1-5段階）

- ⭐⭐⭐⭐⭐: コード/設計書で確認済み、発生メカニズムが明確、影響度評価が完了
- ⭐⭐⭐⭐: コード/設計書で確認済み、発生メカニズムがほぼ明確
- ⭐⭐⭐: コード/設計書で確認済み、発生の可能性を特定
- ⭐⭐: コード/設計書で関連箇所を確認したが、発生条件は推測の域
- ⭐: 一般的なパターンに該当するが、コード/設計書での明確な証拠なし

**重要**: ⭐⭐未満のエッジケースは記載しない。コード/設計書での証拠がないものは推測と見なし除外する。

### エッジケース記載の絶対条件

エッジケースを記載するには、以下すべてを満たす必要がある：
1. コードベース/設計書で具体的な該当箇所を特定できた（ファイル:行番号 または 設計書のセクション）
2. エッジケース発生のメカニズムを論理的に説明できる
3. 実際のコード/設計書でエッジケースの存在を確認した
4. 確度が⭐⭐以上

上記条件を満たさないエッジケースは記載しない。推測のみのケース、一般論、ベストプラクティスの列挙は不要。

### 網羅性と品質のバランス

- ✅ 可能性のあるエッジケースを幅広く調査する（網羅性）
- ✅ ただし、コード/設計書での証拠がない推測は記載しない（品質）
- ❌ 一般論やベストプラクティスの列挙は不要
- ❌ 「このような問題が起こりうる」という可能性の羅列は不要
- ✅ エッジケース数の上限は設けない（網羅性重視）
- ✅ ただし、各ケースは必ず根拠を持つこと（品質重視）

# info

<initial_analysis_template>
あなたはエッジケース分析のエキスパートです。以下の情報に基づいて、システムのエッジケース分析の初期調査を実施してください。

# 重要な分析方針

**網羅性と品質のバランス**:
- ✅ 可能性のあるエッジケースを幅広く調査する（網羅性）
- ✅ ただし、コード/設計書での証拠がない推測は記載しない（品質）
- ❌ 一般論やベストプラクティスの列挙は不要
- ❌ 「このような問題が起こりうる」という可能性の羅列は不要

**エッジケース記載の絶対条件**:
1. コードベース/設計書で具体的な箇所を特定できた
2. エッジケース発生のメカニズムを論理的に説明できる
3. 確度が⭐⭐以上（コード/設計書での証拠がある）

上記を満たさないエッジケースは、たとえ一般的なパターンでも記載しない。

# 分析対象の基本情報

分析対象名: {{分析対象名}} # 要件名 or 分析対象
分析モード: {{分析モード}} # requirements-based or source-based
分析スコープ: {{分析スコープ}}
出力ファイル名: {{ベースディレクトリ}}/initial_analysis.md
カレントディレクトリ: {{カレントディレクトリ}}

# 収集済み情報

{{収集済み情報}}

# 分析の進め方

- 分析モードが "requirements-based" の場合:
  - 要件定義書、設計文書、タスクノートの内容を基に分析を進める
  - 実装予定の機能のエッジケースを予測的に特定する
  - 設計書での記載を証拠として、確度⭐⭐以上のケースを特定

- 分析モードが "source-based" の場合:
  - ソースコードから収集した情報を基に分析を進める
  - 既存の実装を確認しながら、現在のエッジケース対応状況と不足点を特定する
  - コードでの実装状況を証拠として、確度⭐⭐以上のケースを特定

# 重要な注意事項

**すべてのファイルパスは、カレントディレクトリを基準とした相対パスで記載してください。**
**絶対パス（/Users/... や C:\\... など）は使用しないでください。**
**このファイルは500行以内を目標としてください。**
**確度⭐⭐未満のエッジケースは記載しない。推測のみのケースは除外する。**

# 初期分析の手順

## 1. 要件の理解とスコープ確認

- 要件定義書から主要機能を抽出
- 各機能の入出力を特定
- データフローを把握
- 外部システム連携を確認
- 技術スタックとアーキテクチャを理解

## 2. 潜在的なエッジケース領域の特定

### 使用するツール
- Grep: キーワード検索で関連コードを特定
- Glob: ファイルパターンで実装ファイルを列挙
- Read: 特定ファイルの内容確認

### 検索キーワードの選定
- エラーハンドリング: "try", "catch", "throw", "error"
- 非同期処理: "async", "await", "Promise", "setTimeout"
- トランザクション: "transaction", "commit", "rollback"
- バリデーション: "validate", "check", "verify"
- 認証: "auth", "session", "token", "permission"
- ネットワーク: "fetch", "axios", "request", "timeout"

### 検索の実施
1. 各キーワードで Grep 検索
2. 見つかったファイルを Read で確認
3. 既存のエラーハンドリング状況を把握
4. 不足している対応を特定

## 3. レイヤー別の初期調査

### アプリケーション層
- ビジネスロジックの複雑度
- 状態遷移の数
- バリデーションルールの数

### UI層
- 画面数と画面遷移
- フォーム入力の数
- ユーザー操作の種類

### データ管理層
- テーブル数と関連
- トランザクション境界
- キャッシュ戦略

### ネットワーク通信層
- 外部API呼び出し箇所
- タイムアウト設定
- リトライ設定

### 非同期処理層
- ジョブキューの種類
- ワークフローの複雑度
- 並行処理の箇所

### 認証・認可層
- 認証方式
- 権限レベル
- セッション管理方式

## 4. 初期分析結果のまとめ

以下の形式で結果をファイルに出力してください。Write ツールを使用して保存してください。

```markdown
# エッジケース分析 - 初期分析結果

**実施日時**: {{実施日時}}
**分析者**: Claude Code
**分析対象**: {{分析対象名}}
**分析モード**: {{分析モード}}

[← インデックスに戻る](./index.md)

---

## 分析対象の概要

### 要件サマリー
{{要件の概要}}

### 主要機能
1. {{機能1}}
2. {{機能2}}
3. {{機能3}}

### 技術スタック
- フロントエンド: {{技術}}
- バックエンド: {{技術}}
- データベース: {{技術}}
- インフラ: {{技術}}

---

## レイヤー別の初期調査結果

### アプリケーション層

#### 状態遷移の複雑度
- 状態の種類: {{数}}個
- 遷移パターン: {{数}}パターン

#### 識別された潜在的エッジケース

以下は、コード/設計書で確認し、確度⭐⭐以上のエッジケースのみ記載。

1. **{{エッジケース名}}**
   - **確度**: ⭐⭐⭐⭐⭐（必須: ⭐⭐以上）
   - **証拠**: [相対パス:行番号](相対パス#L行番号) または 設計書セクション（必須）
   - **発生条件**: {{具体的な発生メカニズムを論理的に説明}}（必須）
   - **発生可能性**: 高/中/低
   - **影響度**: 高/中/低
   - **現在の対応**: {{対応状況}}
   - **不足している対応**: {{何が不足しているか}}
   - **推奨優先度**: P0/P1/P2/P3

2. **{{エッジケース名}}**
   （同様の形式で複数記載。上記7項目すべて必須）

**重要**: 確度⭐⭐未満、コード/設計書での証拠がないエッジケースは記載しない。

### UI層

#### 画面遷移の複雑度
- 画面数: {{数}}画面
- 遷移パターン: {{数}}パターン

#### 識別された潜在的エッジケース

以下は、コード/設計書で確認し、確度⭐⭐以上のエッジケースのみ記載。

1. **{{エッジケース名}}**
   - **確度**: ⭐⭐⭐⭐⭐（必須: ⭐⭐以上）
   - **証拠**: [相対パス:行番号](相対パス#L行番号) または 設計書セクション（必須）
   - **発生条件**: {{具体的な発生メカニズムを論理的に説明}}（必須）
   - **発生可能性**: 高/中/低
   - **影響度**: 高/中/低
   - **現在の対応**: {{対応状況}}
   - **不足している対応**: {{何が不足しているか}}
   - **推奨優先度**: P0/P1/P2/P3

**重要**: 確度⭐⭐未満、コード/設計書での証拠がないエッジケースは記載しない。

### データ管理層

#### データ構造の複雑度
- テーブル数: {{数}}個
- リレーション数: {{数}}個

#### 識別された潜在的エッジケース

以下は、コード/設計書で確認し、確度⭐⭐以上のエッジケースのみ記載。

1. **{{エッジケース名}}**
   - **確度**: ⭐⭐⭐⭐⭐（必須: ⭐⭐以上）
   - **証拠**: [相対パス:行番号](相対パス#L行番号) または 設計書セクション（必須）
   - **発生条件**: {{具体的な発生メカニズムを論理的に説明}}（必須）
   - **発生可能性**: 高/中/低
   - **影響度**: 高/中/低
   - **現在の対応**: {{対応状況}}
   - **不足している対応**: {{何が不足しているか}}
   - **推奨優先度**: P0/P1/P2/P3

**重要**: 確度⭐⭐未満、コード/設計書での証拠がないエッジケースは記載しない。

### ネットワーク通信層

#### 外部連携の複雑度
- API呼び出し箇所: {{数}}箇所
- タイムアウト設定: {{設定状況}}

#### 識別された潜在的エッジケース

以下は、コード/設計書で確認し、確度⭐⭐以上のエッジケースのみ記載。

1. **{{エッジケース名}}**
   - **確度**: ⭐⭐⭐⭐⭐（必須: ⭐⭐以上）
   - **証拠**: [相対パス:行番号](相対パス#L行番号) または 設計書セクション（必須）
   - **発生条件**: {{具体的な発生メカニズムを論理的に説明}}（必須）
   - **発生可能性**: 高/中/低
   - **影響度**: 高/中/低
   - **現在の対応**: {{対応状況}}
   - **不足している対応**: {{何が不足しているか}}
   - **推奨優先度**: P0/P1/P2/P3

**重要**: 確度⭐⭐未満、コード/設計書での証拠がないエッジケースは記載しない。

### 非同期処理層

#### 非同期処理の複雑度
- ジョブの種類: {{数}}種類
- 並行処理箇所: {{数}}箇所

#### 識別された潜在的エッジケース

以下は、コード/設計書で確認し、確度⭐⭐以上のエッジケースのみ記載。

1. **{{エッジケース名}}**
   - **確度**: ⭐⭐⭐⭐⭐（必須: ⭐⭐以上）
   - **証拠**: [相対パス:行番号](相対パス#L行番号) または 設計書セクション（必須）
   - **発生条件**: {{具体的な発生メカニズムを論理的に説明}}（必須）
   - **発生可能性**: 高/中/低
   - **影響度**: 高/中/低
   - **現在の対応**: {{対応状況}}
   - **不足している対応**: {{何が不足しているか}}
   - **推奨優先度**: P0/P1/P2/P3

**重要**: 確度⭐⭐未満、コード/設計書での証拠がないエッジケースは記載しない。

### 認証・認可層

#### 認証・認可の複雑度
- 認証方式: {{方式}}
- 権限レベル: {{数}}レベル

#### 識別された潜在的エッジケース

以下は、コード/設計書で確認し、確度⭐⭐以上のエッジケースのみ記載。

1. **{{エッジケース名}}**
   - **確度**: ⭐⭐⭐⭐⭐（必須: ⭐⭐以上）
   - **証拠**: [相対パス:行番号](相対パス#L行番号) または 設計書セクション（必須）
   - **発生条件**: {{具体的な発生メカニズムを論理的に説明}}（必須）
   - **発生可能性**: 高/中/低
   - **影響度**: 高/中/低
   - **現在の対応**: {{対応状況}}
   - **不足している対応**: {{何が不足しているか}}
   - **推奨優先度**: P0/P1/P2/P3

**重要**: 確度⭐⭐未満、コード/設計書での証拠がないエッジケースは記載しない。

---

## 関連コードファイル

### 主要な実装ファイル

#### [相対パス](相対パス)
- **役割**: {{ファイルの役割}}
- **エッジケース関連度**: 高/中/低
- **理由**: {{なぜ関連するのか}}

---

## 既存のエラーハンドリング状況

### 実装済みの対応

#### [相対パス:行番号](相対パス#L行番号)
- **対応内容**: {{エラーハンドリングの内容}}
- **カバー範囲**: {{カバーしているケース}}
- **不足点**: {{不足している点}}

### 未実装の対応

1. **{{未実装のケース}}**
   - 必要な対応: {{対応内容}}
   - 優先度: P0/P1/P2/P3

---

## 初期リスク評価

### 高リスク領域

1. **{{リスク領域}}**
   - リスクレベル: クリティカル/高/中/低
   - 理由: {{リスクが高い理由}}
   - 推奨対応: {{推奨される対応}}

### 中リスク領域

（同様の形式で記載）

### 注意が必要な領域

（同様の形式で記載）

---

## 次段階の分析方針

### レイヤー別分析で確認すべき点
1. {{確認ポイント1}}
2. {{確認ポイント2}}
3. {{確認ポイント3}}

### 複合分析で確認すべき点
1. {{確認ポイント1}}
2. {{確認ポイント2}}

---

*この初期分析結果は自動生成されたものです。次段階のレイヤー別分析でさらに詳細を確認します。*
```

最後に、インデックスファイル（{{ベースディレクトリ}}/index.md）も作成してください。インデックスファイルには以下の内容を含めてください：

```markdown
# エッジケース分析 - インデックス

**実施日時**: {{実施日時}}
**分析者**: Claude Code
**分析対象**: {{分析対象名}}
**分析モード**: {{分析モード}}

---

## 📋 チェックリスト

**重要**: 対応が必要なエッジケースの一覧は[チェックリスト](./check_list.md)を参照してください。

- [📋 check_list.md](./check_list.md) - **優先対応すべきエッジケース一覧**

---

## 分析対象情報

### 分析対象の概要
{{分析対象の概要}}

### 分析スコープ
{{分析スコープ}}

---

## 分析結果ファイル一覧

### 分析段階

#### 初期分析
- [初期分析](./initial_analysis.md) - レイヤー別の潜在的エッジケース特定

#### レイヤー別分析（6レイヤー + サマリー）

**注意**: 各レイヤーが500行を超えた場合、枝番ファイル（_1.md, _2.md...）に分割されます。その場合は実際のファイル構成に応じてリンクを記載してください。

- [アプリケーション層](./layer_analysis_app.md) （500行超過時: [第1部](./layer_analysis_app_1.md) | [第2部](./layer_analysis_app_2.md)...）
- [UI層](./layer_analysis_ui.md) （500行超過時: 枝番ファイルへのリンク）
- [データ管理層](./layer_analysis_data.md) （500行超過時: 枝番ファイルへのリンク）
- [ネットワーク通信層](./layer_analysis_network.md) （500行超過時: 枝番ファイルへのリンク）
- [非同期処理層](./layer_analysis_async.md) （500行超過時: 枝番ファイルへのリンク）
- [認証・認可層](./layer_analysis_auth.md) （500行超過時: 枝番ファイルへのリンク）
- [レイヤー別サマリー](./layer_analysis_summary.md)

#### 複合エッジケース分析（4カテゴリ + サマリー）

**注意**: 各カテゴリが500行を超えた場合、枝番ファイルに分割されます。

- [データモデル状態組み合わせ](./combined_analysis_data_state.md) （500行超過時: 枝番ファイルへのリンク）
- [複数レイヤーにまたがるケース](./combined_analysis_multi_layer.md) （500行超過時: 枝番ファイルへのリンク）
- [カスケード障害](./combined_analysis_cascade.md) （500行超過時: 枝番ファイルへのリンク）
- [タイミング依存の問題](./combined_analysis_timing.md) （500行超過時: 枝番ファイルへのリンク）
- [複合分析サマリー](./combined_analysis_summary.md)

#### 最終レポート
- [最終レポート](./final_report.md) - 包括的な分析結果とアクションプラン

---

## クイックサマリー

### 識別された高リスク領域
1. {{高リスク領域1}}
2. {{高リスク領域2}}
3. {{高リスク領域3}}

### 次のアクション
{{次に実施すべきこと}}

---

*分析は段階的に実施されます。各段階の詳細は上記リンクから参照してください。*
```
</initial_analysis_template>

<layer_analysis_template>
あなたはエッジケース分析のエキスパートです。初期分析結果に基づいて、各レイヤーのエッジケースを詳細に分析してください。

# 重要な分析方針

**網羅性と品質のバランス**:
- ✅ 可能性のあるエッジケースを幅広く調査する（網羅性）
- ✅ ただし、コード/設計書での証拠がない推測は記載しない（品質）
- ❌ 一般論やベストプラクティスの列挙は不要
- ❌ 「このような問題が起こりうる」という可能性の羅列は不要

**エッジケース記載の絶対条件**:
1. コードベース/設計書で具体的な箇所を特定できた
2. エッジケース発生のメカニズムを論理的に説明できる
3. 確度が⭐⭐以上（コード/設計書での証拠がある）

上記を満たさないエッジケースは、たとえ一般的なパターンでも記載しない。

# 分析対象の情報

分析対象名: {{分析対象名}}
分析モード: {{分析モード}}
初期分析結果ファイル: {{ベースディレクトリ}}/initial_analysis.md
出力ファイル名: {{ベースディレクトリ}}/layer_analysis.md
カレントディレクトリ: {{カレントディレクトリ}}

# 重要な注意事項

**すべてのファイルパスは、カレントディレクトリを基準とした相対パスで記載してください。**
**絶対パス（/Users/... や C:\\... など）は使用しないでください。**
**各レイヤーを個別のファイルに出力してください。各ファイルは500行以内を目標としてください。**
**500行を超える場合は、枝番（_1, _2, _3...）をつけて複数ファイルに分割してください。**
**確度⭐⭐未満のエッジケースは記載しない。推測のみのケースは除外する。**

# 出力ファイル構成

各レイヤーごとにファイルを作成します。500行を超える場合は枝番ファイルに分割します：

## 基本ファイル（各レイヤー）
1. `{{ベースディレクトリ}}/layer_analysis_app.md` - アプリケーション層（500行超過時: _1.md, _2.md...）
2. `{{ベースディレクトリ}}/layer_analysis_ui.md` - UI層（500行超過時: _1.md, _2.md...）
3. `{{ベースディレクトリ}}/layer_analysis_data.md` - データ管理層（500行超過時: _1.md, _2.md...）
4. `{{ベースディレクトリ}}/layer_analysis_network.md` - ネットワーク通信層（500行超過時: _1.md, _2.md...）
5. `{{ベースディレクトリ}}/layer_analysis_async.md` - 非同期処理層（500行超過時: _1.md, _2.md...）
6. `{{ベースディレクトリ}}/layer_analysis_auth.md` - 認証・認可層（500行超過時: _1.md, _2.md...）
7. `{{ベースディレクトリ}}/layer_analysis_summary.md` - レイヤー別分析のサマリー

## 枝番ファイルのルール
- ファイルが500行を超える場合、`_1`, `_2`, `_3`... の枝番をつける
- 例: `layer_analysis_app_1.md`, `layer_analysis_app_2.md`, `layer_analysis_app_3.md`
- 各枝番ファイルの最後に「[次のファイルへ →](./layer_analysis_app_2.md)」のようなリンクを記載
- サマリーファイルには、すべての枝番ファイルへのリンクを含める

# レイヤー別エッジケース分析の手順

## 1. 初期分析結果の確認

- {{ベースディレクトリ}}/initial_analysis.md を Read で読み込む
- 特定された高リスク領域を把握する
- 分析の焦点を明確にする

## 2. アプリケーション層の詳細分析

### ビジネスロジックの状態遷移
- 正常な状態遷移パス
- 異常な状態遷移パターン
- 状態の不整合が発生する条件
- ロールバックが必要なケース

### バリデーションルール
- 入力値の境界値
- 複数フィールドの組み合わせ
- ビジネスルール違反
- データ型の不一致

### 並行実行
- 同時実行時の競合
- トランザクション分離レベル
- デッドロック発生条件
- 楽観的ロック・悲観的ロック

## 3. UI層の詳細分析

### 画面状態
- ローディング状態
- エラー状態
- 部分的な更新失敗
- オフライン状態

### ユーザー操作
- 予期しない操作順序
- 高速連打
- ブラウザバック
- ページリロード
- タブの切り替え

### 入力値
- 空文字・null・undefined
- 最大長超過
- 特殊文字（SQL injection、XSS）
- 制御文字・絵文字
- 異常なファイルサイズ・形式

## 4. データ管理層の詳細分析

### トランザクション
- コミット失敗
- ロールバック失敗
- 分散トランザクション
- 長時間トランザクション

### データ整合性
- 外部キー制約違反
- 一意制約違反
- NOT NULL制約違反
- CHECK制約違反

### キャッシュ
- キャッシュミス
- キャッシュの期限切れ
- キャッシュとDBの不整合
- キャッシュの破損

### データ同期
- マスタースレーブ遅延
- レプリケーション失敗
- コンフリクト解決
- データロスト

## 5. ネットワーク通信層の詳細分析

### HTTPステータスコード
- 4xx エラー（クライアントエラー）
- 5xx エラー（サーバーエラー）
- 3xx リダイレクト
- タイムアウト

### リトライ戦略
- リトライ回数超過
- 指数バックオフ
- サーキットブレーカー
- べき等性の保証

### ネットワーク障害
- 接続失敗
- DNSエラー
- プロキシエラー
- ファイアウォールブロック

## 6. 非同期処理層の詳細分析

### ジョブキュー
- ジョブ実行失敗
- デッドレター処理
- ジョブの重複実行
- ジョブの順序保証

### ワークフロー
- ステップ失敗
- 補償トランザクション
- タイムアウト
- 中断と再開

### 並行処理
- 競合状態
- デッドロック
- リソース枯渇
- バックプレッシャー

## 7. 認証・認可層の詳細分析

### セッション管理
- セッションタイムアウト
- セッション固定攻撃
- CSRF攻撃
- セッションハイジャック

### トークン管理
- トークン有効期限切れ
- トークンの不正使用
- リフレッシュトークンの失敗
- トークンの漏洩

### 権限管理
- 権限不足
- 権限昇格
- ロールの変更
- リソースへのアクセス制御

## 8. レイヤー別分析結果のまとめ

以下の手順で各レイヤーを個別のファイルに出力してください。Write ツールを使用して保存してください。

### 重要: ファイル分割のルール

1. **行数カウント**: 各ファイルの内容を作成する際、500行を超えるかどうかを確認する
2. **500行以下の場合**: 通常のファイル名で1つのファイルに出力（例: `layer_analysis_app.md`）
3. **500行を超える場合**:
   - 枝番ファイルに分割（例: `layer_analysis_app_1.md`, `layer_analysis_app_2.md`...）
   - 各枝番ファイルは500行以内に収める
   - 各枝番ファイルの最後に次のファイルへのリンクを追加
   - 最初のファイル（_1.md）のヘッダーに「全X部構成」と記載

### ファイル1: layer_analysis_app（アプリケーション層）

**500行以下の場合**: `layer_analysis_app.md`

```markdown
# エッジケース分析 - アプリケーション層

**実施日時**: {{実施日時}}
**分析者**: Claude Code

[← インデックスに戻る](./index.md) | [初期分析](./initial_analysis.md) | [サマリーへ](./layer_analysis_summary.md)
```

**500行を超える場合**: `layer_analysis_app_1.md`, `layer_analysis_app_2.md`...

```markdown
# エッジケース分析 - アプリケーション層（第1部 / 全3部）

**実施日時**: {{実施日時}}
**分析者**: Claude Code

[← インデックスに戻る](./index.md) | [初期分析](./initial_analysis.md) | [サマリーへ](./layer_analysis_summary.md)

---

## アプリケーション層のエッジケース

### EDGE-APP-001: {{エッジケース名}}

**カテゴリ**: ビジネスロジック / バリデーション / 並行実行

**発生条件**:
{{このエッジケースが発生する条件}}

**発生可能性**: 高 / 中 / 低
**影響度**: 高 / 中 / 低
**リスクレベル**: クリティカル / 高 / 中 / 低

**シナリオ**:
```
1. {{ステップ1}}
   ↓
2. {{ステップ2}}
   ↓
3. {{エッジケース発生}}
```

**影響範囲**:
- ユーザー影響: {{ユーザーへの影響}}
- システム影響: {{システムへの影響}}
- データ影響: {{データへの影響}}

**現在の対応状況**:
- 実装済み: ✅ / ❌
- 対応箇所: [相対パス:行番号](相対パス#L行番号)
- 対応内容: {{対応の詳細}}

**推奨対応**:
- 優先度: P0 / P1 / P2 / P3
- 対応方針: {{推奨される対応方針}}
- 実装方法: {{具体的な実装方法}}
- テスト方法: {{テストケース}}

**関連エッジケース**: EDGE-APP-002, EDGE-UI-001

---

### EDGE-APP-002: {{エッジケース名}}

（同様の形式で複数記載）

---

**ファイル分割について**:
- このファイルが500行以内の場合: ここで終了
- このファイルが500行を超える場合:
  - 現在のファイルを `layer_analysis_app_1.md` として保存
  - 以下のナビゲーションを最後に追加:
    ```
    ---
    [← 前のファイル](該当なし) | [インデックス](./index.md) | [次のファイルへ →](./layer_analysis_app_2.md)
    ```
  - 続きを `layer_analysis_app_2.md` として作成
  - 2つ目のファイルも500行を超える場合は `layer_analysis_app_3.md` を作成、以降同様

**重要**: エッジケースが多い場合でも省略せず、すべて記載してください。ファイル分割で対応します。
```

### ファイル2: layer_analysis_ui.md（UI層）

```markdown
# エッジケース分析 - UI層

**実施日時**: {{実施日時}}
**分析者**: Claude Code

[← インデックスに戻る](./index.md) | [初期分析](./initial_analysis.md) | [サマリーへ](./layer_analysis_summary.md)

---

## UI層のエッジケース

### EDGE-UI-001: {{エッジケース名}}

**カテゴリ**: 画面状態 / ユーザー操作 / 入力値

**発生条件**:
{{このエッジケースが発生する条件}}

**発生可能性**: 高 / 中 / 低
**影響度**: 高 / 中 / 低
**リスクレベル**: クリティカル / 高 / 中 / 低

**シナリオ**:
{{詳細なシナリオ}}

**影響範囲**:
{{影響の詳細}}

**現在の対応状況**:
{{対応状況}}

**推奨対応**:
{{推奨される対応}}

**関連エッジケース**: EDGE-UI-002, EDGE-APP-001

---

### EDGE-UI-002: {{エッジケース名}}

（同様の形式で複数記載）

---

## データ管理層のエッジケース

### EDGE-DATA-001: {{エッジケース名}}

**カテゴリ**: トランザクション / データ整合性 / キャッシュ / データ同期

**発生条件**:
{{このエッジケースが発生する条件}}

**発生可能性**: 高 / 中 / 低
**影響度**: 高 / 中 / 低
**リスクレベル**: クリティカル / 高 / 中 / 低

**シナリオ**:
{{詳細なシナリオ}}

**データ状態**:
| データ | 正常状態 | 異常状態 | 影響 |
|--------|---------|---------|------|
| {{データ1}} | {{正常値}} | {{異常値}} | {{影響}} |
| {{データ2}} | {{正常値}} | {{異常値}} | {{影響}} |

**影響範囲**:
{{影響の詳細}}

**現在の対応状況**:
{{対応状況}}

**推奨対応**:
{{推奨される対応}}

**関連エッジケース**: EDGE-DATA-002, EDGE-APP-003

---

### EDGE-DATA-002: {{エッジケース名}}

（同様の形式で複数記載）

---

## ネットワーク通信層のエッジケース

### EDGE-NET-001: {{エッジケース名}}

**カテゴリ**: HTTPエラー / タイムアウト / リトライ / ネットワーク障害

**発生条件**:
{{このエッジケースが発生する条件}}

**発生可能性**: 高 / 中 / 低
**影響度**: 高 / 中 / 低
**リスクレベル**: クリティカル / 高 / 中 / 低

**シナリオ**:
{{詳細なシナリオ}}

**ネットワークフロー**:
```
Client → [障害点] → Server
```

**影響範囲**:
{{影響の詳細}}

**現在の対応状況**:
{{対応状況}}

**推奨対応**:
{{推奨される対応}}

**関連エッジケース**: EDGE-NET-002, EDGE-ASYNC-001

---

### EDGE-NET-002: {{エッジケース名}}

（同様の形式で複数記載）

---

## 非同期処理層のエッジケース

### EDGE-ASYNC-001: {{エッジケース名}}

**カテゴリ**: ジョブキュー / ワークフロー / 並行処理

**発生条件**:
{{このエッジケースが発生する条件}}

**発生可能性**: 高 / 中 / 低
**影響度**: 高 / 中 / 低
**リスクレベル**: クリティカル / 高 / 中 / 低

**シナリオ**:
{{詳細なシナリオ}}

**タイムライン**:
```
T0: {{イベント1}}
T1: {{イベント2}}
T2: {{エッジケース発生}}
```

**影響範囲**:
{{影響の詳細}}

**現在の対応状況**:
{{対応状況}}

**推奨対応**:
{{推奨される対応}}

**関連エッジケース**: EDGE-ASYNC-002, EDGE-DATA-001

---

### EDGE-ASYNC-002: {{エッジケース名}}

（同様の形式で複数記載）

---

## 認証・認可層のエッジケース

### EDGE-AUTH-001: {{エッジケース名}}

**カテゴリ**: セッション / トークン / 権限

**発生条件**:
{{このエッジケースが発生する条件}}

**発生可能性**: 高 / 中 / 低
**影響度**: 高 / 中 / 低
**リスクレベル**: クリティカル / 高 / 中 / 低

**シナリオ**:
{{詳細なシナリオ}}

**セキュリティ影響**:
{{セキュリティへの影響}}

**影響範囲**:
{{影響の詳細}}

**現在の対応状況**:
{{対応状況}}

**推奨対応**:
{{推奨される対応}}

**関連エッジケース**: EDGE-AUTH-002, EDGE-APP-001

---

### EDGE-AUTH-002: {{エッジケース名}}

（同様の形式で複数記載）

---

**注意**: このファイルは500行以内に収めてください。
```

**重要**: 上記の形式で、データ管理層、ネットワーク通信層、非同期処理層、認証・認可層についても同様に個別ファイルを作成してください。

## 7. チェックリスト項目の抽出

各レイヤー分析ファイルの作成後、以下の形式でチェックリスト項目を抽出してください：

**抽出ルール**:
- P0（即座に対応）: リスクレベルがクリティカルのエッジケース
- P1（早急に対応）: リスクレベルが高のエッジケース
- P2（計画的に対応）: リスクレベルが中のエッジケース
- P3（監視）: リスクレベルが低のエッジケース

**出力フォーマット** (ファイルの最後に追記):
```markdown
---

## チェックリスト項目

### P0
- [ ] P0 EDGE-APP-001: {{エッジケース名の要約}} [詳細](./layer_analysis_app.md#edge-app-001)

### P1
- [ ] P1 EDGE-APP-005: {{エッジケース名の要約}} [詳細](./layer_analysis_app.md#edge-app-005)

### P2
（同様に記載）

### P3
（同様に記載）
```

**注意**:
- エッジケース名は簡潔に（50文字以内）
- 各項目は1行で記述
- リンクは必ず含める
- 500行制限内に収めること

### ファイル7: layer_analysis_summary.md（サマリー）

```markdown
# エッジケース分析 - レイヤー別サマリー

**実施日時**: {{実施日時}}
**分析者**: Claude Code

[← インデックスに戻る](./index.md) | [初期分析](./initial_analysis.md)

---

## レイヤー別ファイル

**注意**: 各レイヤーが500行を超えて枝番ファイルに分割されている場合は、すべての枝番ファイルへのリンクを記載してください。

例（500行以内の場合）:
- [アプリケーション層](./layer_analysis_app.md)

例（500行超過で枝番ファイルがある場合）:
- アプリケーション層: [第1部](./layer_analysis_app_1.md) | [第2部](./layer_analysis_app_2.md) | [第3部](./layer_analysis_app_3.md)

**実際のリンク**（各レイヤーの実際の状況に応じて記載）:
- [アプリケーション層](./layer_analysis_app.md) （または枝番ファイルへのリンク）
- [UI層](./layer_analysis_ui.md) （または枝番ファイルへのリンク）
- [データ管理層](./layer_analysis_data.md) （または枝番ファイルへのリンク）
- [ネットワーク通信層](./layer_analysis_network.md) （または枝番ファイルへのリンク）
- [非同期処理層](./layer_analysis_async.md) （または枝番ファイルへのリンク）
- [認証・認可層](./layer_analysis_auth.md) （または枝番ファイルへのリンク）

---

## レイヤー別サマリー

### 発見されたエッジケース数

| レイヤー | 合計 | クリティカル | 高 | 中 | 低 |
|---------|------|------------|----|----|----|
| アプリケーション | {{数}} | {{数}} | {{数}} | {{数}} | {{数}} |
| UI | {{数}} | {{数}} | {{数}} | {{数}} | {{数}} |
| データ管理 | {{数}} | {{数}} | {{数}} | {{数}} | {{数}} |
| ネットワーク | {{数}} | {{数}} | {{数}} | {{数}} | {{数}} |
| 非同期処理 | {{数}} | {{数}} | {{数}} | {{数}} | {{数}} |
| 認証・認可 | {{数}} | {{数}} | {{数}} | {{数}} | {{数}} |
| **合計** | {{数}} | {{数}} | {{数}} | {{数}} | {{数}} |

### 発生可能性別分布

| 発生可能性 | 件数 | 割合 |
|----------|------|------|
| 高 | {{数}} | {{割合}}% |
| 中 | {{数}} | {{割合}}% |
| 低 | {{数}} | {{割合}}% |

### 影響度別分布

| 影響度 | 件数 | 割合 |
|-------|------|------|
| 高 | {{数}} | {{割合}}% |
| 中 | {{数}} | {{割合}}% |
| 低 | {{数}} | {{割合}}% |

---

## 次段階の複合分析で確認すべき点

1. {{確認ポイント1}}
2. {{確認ポイント2}}
3. {{確認ポイント3}}

---

*このレイヤー別分析結果に基づいて、次段階で複合エッジケース分析を実施します。*
```
</layer_analysis_template>

<combined_analysis_template>
あなたはエッジケース分析のエキスパートです。これまでの分析結果に基づいて、複数レイヤーにまたがる複合的なエッジケースを分析してください。

# 重要な分析方針

**網羅性と品質のバランス**:
- ✅ 可能性のあるエッジケースを幅広く調査する（網羅性）
- ✅ ただし、コード/設計書での証拠がない推測は記載しない（品質）
- ❌ 一般論やベストプラクティスの列挙は不要
- ❌ 「このような問題が起こりうる」という可能性の羅列は不要

**エッジケース記載の絶対条件**:
1. コードベース/設計書で具体的な箇所を特定できた
2. エッジケース発生のメカニズムを論理的に説明できる
3. 確度が⭐⭐以上（コード/設計書での証拠がある）

上記を満たさないエッジケースは、たとえ一般的なパターンでも記載しない。

# 分析対象の情報

分析対象名: {{分析対象名}}
分析モード: {{分析モード}}
初期分析結果ファイル: {{ベースディレクトリ}}/initial_analysis.md
レイヤー別分析ファイル: {{ベースディレクトリ}}/layer_analysis.md
出力ファイル名: {{ベースディレクトリ}}/combined_analysis.md
カレントディレクトリ: {{カレントディレクトリ}}

# 重要な注意事項

**すべてのファイルパスは、カレントディレクトリを基準とした相対パスで記載してください。**
**絶対パス（/Users/... や C:\\... など）は使用しないでください。**
**各カテゴリを個別のファイルに出力してください。各ファイルは500行以内を目標としてください。**
**500行を超える場合は、枝番（_1, _2, _3...）をつけて複数ファイルに分割してください。**
**確度⭐⭐未満のエッジケースは記載しない。推測のみのケースは除外する。**

# 出力ファイル構成

各カテゴリごとにファイルを作成します。500行を超える場合は枝番ファイルに分割します：

## 基本ファイル（各カテゴリ）
1. `{{ベースディレクトリ}}/combined_analysis_data_state.md` - データモデル状態組み合わせ（超過時: _1.md, _2.md...）
2. `{{ベースディレクトリ}}/combined_analysis_multi_layer.md` - 複数レイヤーにまたがるケース（超過時: _1.md, _2.md...）
3. `{{ベースディレクトリ}}/combined_analysis_cascade.md` - カスケード障害（超過時: _1.md, _2.md...）
4. `{{ベースディレクトリ}}/combined_analysis_timing.md` - タイミング依存の問題（超過時: _1.md, _2.md...）
5. `{{ベースディレクトリ}}/combined_analysis_summary.md` - 複合分析のサマリー

## 枝番ファイルのルール
- ファイルが500行を超える場合、`_1`, `_2`, `_3`... の枝番をつける
- 例: `combined_analysis_data_state_1.md`, `combined_analysis_data_state_2.md`
- 各枝番ファイルの最後に「[次のファイルへ →](./combined_analysis_data_state_2.md)」のようなリンクを記載
- サマリーファイルには、すべての枝番ファイルへのリンクを含める

# 複合エッジケース分析の手順

## 1. これまでの分析結果の統合

- {{ベースディレクトリ}}/initial_analysis.md を Read で読み込む
- {{ベースディレクトリ}}/layer_analysis.md を Read で読み込む
- レイヤー間の依存関係を把握する
- 複合的に発生するパターンを特定する

## 2. データモデル状態の組み合わせ分析

### 複数エンティティの状態組み合わせ
- エンティティA × エンティティB の状態マトリクス
- 不整合が発生する組み合わせ
- データ整合性制約

### マスタとトランザクションの不整合
- マスタデータ更新中のトランザクション処理
- マスタデータ削除後の参照
- バージョン不整合

## 3. 複数レイヤーにまたがるエッジケース

### UI × アプリケーション × データ
- ユーザー操作 → ビジネスロジック → データ永続化の連鎖
- 各層での障害伝播
- 部分的な成功・失敗

### アプリケーション × ネットワーク × 非同期
- API呼び出し → ジョブキュー → 非同期処理の連鎖
- タイムアウトとリトライの影響
- 分散トランザクション

### 認証 × ネットワーク × データ
- セッションタイムアウト中のデータ更新
- トークン更新中のAPI呼び出し
- 権限変更の伝播

## 4. カスケード障害の分析

### 障害の連鎖パターン
- 一次障害 → 二次障害 → 三次障害
- リソース枯渇の連鎖
- サーキットブレーカーの発動

### リカバリーの複雑度
- 部分的なロールバック
- 補償トランザクション
- 手動介入が必要なケース

## 5. タイミング依存の問題

### 競合状態
- 複数リクエストの同時処理
- 読み取り → 更新の間のデータ変更
- 楽観的ロックの失敗

### デッドロック
- リソースの循環待ち
- タイムアウト設定
- デッドロック検出と解消

## 6. 複合分析結果のまとめ

以下の手順で各カテゴリを個別のファイルに出力してください。Write ツールを使用して保存してください。

### 重要: ファイル分割のルール

1. **行数カウント**: 各ファイルの内容を作成する際、500行を超えるかどうかを確認する
2. **500行以下の場合**: 通常のファイル名で1つのファイルに出力（例: `combined_analysis_data_state.md`）
3. **500行を超える場合**:
   - 枝番ファイルに分割（例: `combined_analysis_data_state_1.md`, `combined_analysis_data_state_2.md`...）
   - 各枝番ファイルは500行以内に収める
   - 各枝番ファイルの最後に次のファイルへのリンクを追加
   - 最初のファイル（_1.md）のヘッダーに「全X部構成」と記載

### ファイル1: combined_analysis_data_state（データモデル状態組み合わせ）

**500行以下の場合**: `combined_analysis_data_state.md`

```markdown
# エッジケース分析 - データモデル状態組み合わせ

**実施日時**: {{実施日時}}
**分析者**: Claude Code

[← インデックスに戻る](./index.md) | [初期分析](./initial_analysis.md) | [レイヤー別サマリー](./layer_analysis_summary.md) | [複合分析サマリー](./combined_analysis_summary.md)
```

**500行を超える場合**: `combined_analysis_data_state_1.md`, `combined_analysis_data_state_2.md`...

```markdown
# エッジケース分析 - データモデル状態組み合わせ（第1部 / 全2部）

**実施日時**: {{実施日時}}
**分析者**: Claude Code

[← インデックスに戻る](./index.md) | [初期分析](./initial_analysis.md) | [レイヤー別サマリー](./layer_analysis_summary.md) | [複合分析サマリー](./combined_analysis_summary.md)

---

## データモデル状態の組み合わせ

### EDGE-COMB-001: {{複合エッジケース名}}

**関連レイヤー**: データ管理 / アプリケーション

**関連するエッジケース**: EDGE-DATA-001, EDGE-APP-002

**発生条件**:
{{このエッジケースが発生する条件}}

**データ状態マトリクス**:
| エンティティA | エンティティB | 結果 | 問題 |
|-------------|-------------|------|------|
| 状態1 | 状態1 | ✅ 正常 | なし |
| 状態1 | 状態2 | ⚠️ 警告 | {{問題}} |
| 状態2 | 状態1 | ❌ エラー | {{問題}} |
| 状態2 | 状態2 | ❌ エラー | {{問題}} |

**発生可能性**: 高 / 中 / 低
**影響度**: 高 / 中 / 低
**リスクレベル**: クリティカル / 高 / 中 / 低

**複合シナリオ**:
```
[データ層]
1. エンティティAが状態1
2. エンティティBが状態2に遷移
   ↓
[アプリケーション層]
3. ビジネスルール検証でエラー
   ↓
[影響]
4. データ不整合が発生
```

**影響範囲**:
- データ整合性: {{影響}}
- ユーザー体験: {{影響}}
- システム安定性: {{影響}}

**現在の対応状況**:
{{対応状況}}

**推奨対応**:
- 優先度: P0 / P1 / P2 / P3
- 対応方針: {{推奨される対応方針}}
- 実装箇所: [相対パス](相対パス)
- テスト戦略: {{テスト方法}}

---

### EDGE-COMB-002: {{複合エッジケース名}}

（同様の形式で複数記載）

---

**注意**: このファイルは500行以内に収めてください。
```

### ファイル2～4: 他のカテゴリ

**重要**: 上記と同様の形式で、以下のファイルも作成してください：
- `combined_analysis_multi_layer.md` - 複数レイヤーにまたがるエッジケース
- `combined_analysis_cascade.md` - カスケード障害
- `combined_analysis_timing.md` - タイミング依存の問題

各ファイルは500行以内に収めてください。

## 7. チェックリスト項目の抽出

各複合分析ファイルの作成後、以下の形式でチェックリスト項目を抽出してください：

**抽出ルール**:
- P0（即座に対応）: リスクレベルがクリティカルのエッジケース
- P1（早急に対応）: リスクレベルが高のエッジケース
- P2（計画的に対応）: リスクレベルが中のエッジケース
- P3（監視）: リスクレベルが低のエッジケース

**出力フォーマット** (ファイルの最後に追記):
```markdown
---

## チェックリスト項目

### P0
- [ ] P0 EDGE-COMB-001: {{エッジケース名の要約}} [詳細](./combined_analysis_data_state.md#edge-comb-001)

### P1
- [ ] P1 EDGE-MULTI-003: {{エッジケース名の要約}} [詳細](./combined_analysis_multi_layer.md#edge-multi-003)

### P2
（同様に記載）

### P3
（同様に記載）
```

**注意**:
- エッジケース名は簡潔に（50文字以内）
- 各項目は1行で記述
- リンクは必ず含める
- 500行制限内に収めること

### ファイル5: combined_analysis_summary.md（サマリー）

```markdown
# エッジケース分析 - 複合分析サマリー

**実施日時**: {{実施日時}}
**分析者**: Claude Code

[← インデックスに戻る](./index.md) | [初期分析](./initial_analysis.md) | [レイヤー別サマリー](./layer_analysis_summary.md)

---

## 複合分析ファイル

**注意**: 各カテゴリが500行を超えて枝番ファイルに分割されている場合は、すべての枝番ファイルへのリンクを記載してください。

例（500行以内の場合）:
- [データモデル状態組み合わせ](./combined_analysis_data_state.md)

例（500行超過で枝番ファイルがある場合）:
- データモデル状態組み合わせ: [第1部](./combined_analysis_data_state_1.md) | [第2部](./combined_analysis_data_state_2.md)

**実際のリンク**（各カテゴリの実際の状況に応じて記載）:
- [データモデル状態組み合わせ](./combined_analysis_data_state.md) （または枝番ファイルへのリンク）
- [複数レイヤーにまたがるケース](./combined_analysis_multi_layer.md) （または枝番ファイルへのリンク）
- [カスケード障害](./combined_analysis_cascade.md) （または枝番ファイルへのリンク）
- [タイミング依存の問題](./combined_analysis_timing.md) （または枝番ファイルへのリンク）

---

## 複数レイヤーにまたがるエッジケース

### EDGE-MULTI-001: {{複合エッジケース名}}

**関連レイヤー**: UI / アプリケーション / データ管理

**関連するエッジケース**: EDGE-UI-001, EDGE-APP-001, EDGE-DATA-001

**発生条件**:
{{このエッジケースが発生する条件}}

**レイヤー間フロー**:
```
[UI層]
1. ユーザーが操作実行
   ↓ (API呼び出し)
[アプリケーション層]
2. バリデーション通過
3. ビジネスロジック実行
   ↓ (データベース操作)
[データ管理層]
4. トランザクション開始
5. ⚠️ 制約違反エラー発生
   ↓ (エラー伝播)
[アプリケーション層]
6. ロールバック試行
7. ⚠️ ロールバック失敗
   ↓ (エラー伝播)
[UI層]
8. ❌ エラー表示
9. ⚠️ 画面状態が不整合
```

**発生可能性**: 高 / 中 / 低
**影響度**: 高 / 中 / 低
**リスクレベル**: クリティカル / 高 / 中 / 低

**影響範囲**:
{{影響の詳細}}

**現在の対応状況**:
{{対応状況}}

**推奨対応**:
{{推奨される対応}}

---

### EDGE-MULTI-002: {{複合エッジケース名}}

（同様の形式で複数記載）

---

## カスケード障害

### EDGE-CASCADE-001: {{カスケード障害名}}

**障害の連鎖**:
```
[一次障害]
データベース接続プール枯渇
   ↓
[二次障害]
API呼び出しタイムアウト多発
   ↓
[三次障害]
リトライによる負荷増大
   ↓
[四次障害]
システム全体の応答遅延
   ↓
[最終影響]
サービス停止
```

**発生可能性**: 高 / 中 / 低
**影響度**: 高 / 中 / 低
**リスクレベル**: クリティカル / 高 / 中 / 低

**トリガー条件**:
{{障害が連鎖するきっかけ}}

**影響範囲**:
{{影響の詳細}}

**検知方法**:
{{どのように検知するか}}

**リカバリー方法**:
{{どのように復旧するか}}

**現在の対応状況**:
{{対応状況}}

**推奨対応**:
- サーキットブレーカーの実装
- バックプレッシャーの実装
- リソース監視の強化
- 段階的な縮退運転

---

### EDGE-CASCADE-002: {{カスケード障害名}}

（同様の形式で複数記載）

---

## タイミング依存の問題

### EDGE-TIMING-001: {{タイミング依存の問題名}}

**競合条件**:
```
[Thread A]                    [Thread B]
1. データ読み取り             1. データ読み取り
   value = 100                   value = 100
   ↓                            ↓
2. 計算処理                   2. 計算処理
   newValue = 100 + 10          newValue = 100 + 20
   ↓                            ↓
3. データ書き込み             3. データ書き込み
   value = 110                  value = 120
   ↓                            ↓
[結果]
期待値: 130
実際値: 120 (10が失われる)
```

**発生可能性**: 高 / 中 / 低
**影響度**: 高 / 中 / 低
**リスクレベル**: クリティカル / 高 / 中 / 低

**影響範囲**:
{{影響の詳細}}

**現在の対応状況**:
{{対応状況}}

**推奨対応**:
- 楽観的ロックの実装
- 悲観的ロックの実装
- トランザクション分離レベルの見直し
- 冪等性の保証

---

### EDGE-TIMING-002: {{タイミング依存の問題名}}

（同様の形式で複数記載）

---

## 複合エッジケースサマリー

### 発見された複合エッジケース数

| カテゴリ | 合計 | クリティカル | 高 | 中 | 低 |
|---------|------|------------|----|----|----| | データモデル組み合わせ | {{数}} | {{数}} | {{数}} | {{数}} | {{数}} |
| 複数レイヤー | {{数}} | {{数}} | {{数}} | {{数}} | {{数}} |
| カスケード障害 | {{数}} | {{数}} | {{数}} | {{数}} | {{数}} |
| タイミング依存 | {{数}} | {{数}} | {{数}} | {{数}} | {{数}} |
| **合計** | {{数}} | {{数}} | {{数}} | {{数}} | {{数}} |

### 最も危険な複合エッジケース Top 5

1. **{{エッジケース名}}** - リスクレベル: {{レベル}}
   - 理由: {{危険な理由}}

2. **{{エッジケース名}}** - リスクレベル: {{レベル}}
   - 理由: {{危険な理由}}

（以下同様）

---

## 推奨される対応優先順位

### P0（即座に対応）

- EDGE-COMB-001: {{エッジケース名}}
- EDGE-CASCADE-001: {{エッジケース名}}

### P1（早急に対応）

- EDGE-MULTI-001: {{エッジケース名}}
- EDGE-TIMING-001: {{エッジケース名}}

### P2（計画的に対応）

（同様にリスト）

### P3（監視）

（同様にリスト）

---

*この複合エッジケース分析結果は、最終レポートで総括されます。*
```
</combined_analysis_template>

<final_report_template>
あなたはエッジケース分析のエキスパートです。これまでのすべての分析結果を統合し、包括的な最終レポートを作成してください。

# 重要な分析方針

**網羅性と品質のバランス**:
- ✅ 分析プロセスで得られた重要なエッジケースを漏れなく記載（網羅性）
- ✅ ただし、除外されたケースや根拠不足の推測は記載しない（品質）
- ❌ 一般論やベストプラクティスの列挙は不要
- ❌ 「このような問題が起こりうる」という可能性の羅列は不要

**レポート記載の原則**:
1. 確度⭐⭐以上のエッジケースのみを含める
2. コード/設計書での証拠に基づく内容のみ記載
3. 除外したケースは詳細分析ファイルを参照し、最終レポートには含めない

# レポート作成対象の情報

分析対象名: {{分析対象名}}
分析モード: {{分析モード}}
分析ファイルリスト: {{分析ファイルリスト}}
最終レポートファイル名: {{ベースディレクトリ}}/final_report.md
カレントディレクトリ: {{カレントディレクトリ}}

# 重要な注意事項

**すべてのファイルパスは、カレントディレクトリを基準とした相対パスで記載してください。**
**絶対パス（/Users/... や C:\\... など）は使用しないでください。**
**このファイルは500行以内を目標としてください。**
**確度⭐⭐以上、コード/設計書での証拠がある内容のみ記載する。**

# 最終レポート作成手順

## 1. 全分析結果の読み込み

- {{ベースディレクトリ}}/initial_analysis.md を Read で読み込む
- {{ベースディレクトリ}}/layer_analysis.md を Read で読み込む
- {{ベースディレクトリ}}/combined_analysis.md を Read で読み込む
- 各ファイルの内容を把握し、重要なポイントを抽出する

## 2. 情報の統合とサマリー作成

- 全エッジケースのリスク評価
- 対応優先順位の決定
- テスト戦略の策定
- 監視・運用方針の策定

## 3. エグゼクティブサマリーの作成

- 非技術者にも理解できる概要
- 技術的な詳細は別セクションで説明
- 結論を先に、詳細は後で

## 4. 最終レポートの出力

以下の形式で結果をファイルに出力してください。Write ツールを使用して保存してください。

```markdown
# エッジケース分析 - 最終レポート

**実施日時**: {{実施日時}}
**分析者**: Claude Code
**分析対象**: {{分析対象名}}
**分析モード**: {{分析モード}}

---

## ナビゲーション

- [インデックス](./index.md) - 全体概要とファイル一覧
- [📋 チェックリスト](./check_list.md) - **優先対応すべきエッジケース一覧**
- [初期分析](./initial_analysis.md) - 潜在的エッジケース特定
- レイヤー別分析:
  - [アプリケーション層](./layer_analysis_app.md)
  - [UI層](./layer_analysis_ui.md)
  - [データ管理層](./layer_analysis_data.md)
  - [ネットワーク通信層](./layer_analysis_network.md)
  - [非同期処理層](./layer_analysis_async.md)
  - [認証・認可層](./layer_analysis_auth.md)
  - [レイヤー別サマリー](./layer_analysis_summary.md)
- 複合エッジケース分析:
  - [データモデル状態組み合わせ](./combined_analysis_data_state.md)
  - [複数レイヤー](./combined_analysis_multi_layer.md)
  - [カスケード障害](./combined_analysis_cascade.md)
  - [タイミング依存](./combined_analysis_timing.md)
  - [複合分析サマリー](./combined_analysis_summary.md)

---

## 📋 チェックリスト概要

**総チェックリスト項目数**: {{総数}}件

| 優先度 | 項目数 | 説明 |
|-------|-------|------|
| P0 | {{P0数}}件 | 即座に対応が必要（リリース前必須） |
| P1 | {{P1数}}件 | 早急に対応（初期リリースに含める） |
| P2 | {{P2数}}件 | 計画的に対応（次期バージョン） |
| P3 | {{P3数}}件 | 監視（ログ・監視で検知） |

**詳細は [check_list.md](./check_list.md) を参照してください**

---

## エグゼクティブサマリー

### 分析概要

本レポートは、{{分析対象名}}のシステム実装における包括的なエッジケース分析結果です。

### 主要な発見事項

- **総エッジケース数**: {{総数}}件
- **クリティカルリスク**: {{数}}件
- **高リスク**: {{数}}件
- **即座に対応が必要（P0）**: {{数}}件

### リスク評価サマリー

**最大リスク領域**: {{レイヤー名}}
- クリティカルケース: {{数}}件
- 主な懸念: {{懸念事項}}

### 推奨される対応

**即座に実施すべき対応（P0）**: {{数}}件
- {{対応1}}
- {{対応2}}
- {{対応3}}

**リリースへの影響**:
- P0対応完了前のリリース: ❌ 推奨しない
- P0+P1対応後のリリース: ✅ 推奨
- 最小構成リリース: {{条件付きで可能かどうか}}

---

## 全体統計

### レイヤー別エッジケース分布

| レイヤー | 合計 | クリティカル | 高 | 中 | 低 |
|---------|------|------------|----|----|----| | アプリケーション | {{数}} | {{数}} | {{数}} | {{数}} | {{数}} |
| UI | {{数}} | {{数}} | {{数}} | {{数}} | {{数}} |
| データ管理 | {{数}} | {{数}} | {{数}} | {{数}} | {{数}} |
| ネットワーク | {{数}} | {{数}} | {{数}} | {{数}} | {{数}} |
| 非同期処理 | {{数}} | {{数}} | {{数}} | {{数}} | {{数}} |
| 認証・認可 | {{数}} | {{数}} | {{数}} | {{数}} | {{数}} |
| 複合 | {{数}} | {{数}} | {{数}} | {{数}} | {{数}} |
| **合計** | {{数}} | {{数}} | {{数}} | {{数}} | {{数}} |

### リスクマトリクス

|  | 高影響度 | 中影響度 | 低影響度 |
|----------|---------|---------|---------|
| **高発生可能性** | {{数}}件（クリティカル） | {{数}}件（高） | {{数}}件（中） |
| **中発生可能性** | {{数}}件（高） | {{数}}件（中） | {{数}}件（低） |
| **低発生可能性** | {{数}}件（中） | {{数}}件（低） | {{数}}件（低） |

---

## クリティカルエッジケース詳細

### CRITICAL-01: {{エッジケース名}}

**ID**: {{元のID（例: EDGE-COMB-001）}}
**リスクレベル**: クリティカル
**発生可能性**: 高
**影響度**: 高

**概要**:
{{エッジケースの簡潔な説明}}

**ビジネスインパクト**:
{{ユーザーやビジネスへの影響}}

**技術的詳細**:
{{技術的な問題の詳細}}

**推奨対応**:
- **優先度**: P0（即座に対応）
- **対応方針**: {{対応方針}}
- **実装工数**: {{概算工数}}
- **完了目標**: リリース前必須

**参照**: [詳細分析](./layer_analysis.md#{{anchor}})

---

### CRITICAL-02: {{エッジケース名}}

（同様の形式で複数記載）

---

## 対応優先順位別アクションプラン

### P0: 即座に対応（{{数}}件）

#### 1. {{エッジケース名}}
- **ID**: {{ID}}
- **対応内容**: {{対応内容}}
- **実装箇所**: [相対パス](相対パス)
- **テスト方法**: {{テスト方法}}
- **担当推奨**: {{担当者のスキルセット}}
- **工数**: {{工数}}

#### 2. {{エッジケース名}}
（同様の形式で複数記載）

### P1: 早急に対応（{{数}}件）

#### 1. {{エッジケース名}}
- **ID**: {{ID}}
- **対応内容**: {{対応内容}}
- **実装箇所**: [相対パス](相対パス)
- **テスト方法**: {{テスト方法}}
- **工数**: {{工数}}

### P2: 計画的に対応（{{数}}件）

（同様の形式でリスト）

### P3: 監視（{{数}}件）

（同様の形式でリスト）

---

## テスト戦略

### エッジケーステストの優先順位

#### Phase 1: クリティカル・高リスクケース
- **対象**: P0, P1のエッジケース
- **テスト種別**: ユニット、統合、E2E
- **カバレッジ目標**: 100%

#### Phase 2: 中リスクケース
- **対象**: P2のエッジケース
- **テスト種別**: ユニット、統合
- **カバレッジ目標**: 80%

#### Phase 3: 低リスクケース
- **対象**: P3のエッジケース
- **テスト種別**: 主にユニット
- **カバレッジ目標**: 50%

### レイヤー別テスト推奨事項

#### アプリケーション層
- ユニットテスト: {{推奨事項}}
- 統合テスト: {{推奨事項}}
- Property-based testing: {{推奨事項}}

#### UI層
- E2Eテスト: {{推奨事項}}
- ビジュアルリグレッションテスト: {{推奨事項}}
- アクセシビリティテスト: {{推奨事項}}

#### データ管理層
- トランザクションテスト: {{推奨事項}}
- 負荷テスト: {{推奨事項}}
- カオステスト: {{推奨事項}}

#### ネットワーク通信層
- モック・スタブテスト: {{推奨事項}}
- タイムアウトテスト: {{推奨事項}}
- リトライテスト: {{推奨事項}}

#### 非同期処理層
- 並行処理テスト: {{推奨事項}}
- ワークフローテスト: {{推奨事項}}
- 冪等性テスト: {{推奨事項}}

#### 認証・認可層
- セキュリティテスト: {{推奨事項}}
- セッション管理テスト: {{推奨事項}}
- 権限テスト: {{推奨事項}}

### テスト自動化の推奨

- CI/CDパイプラインへの組み込み: {{推奨事項}}
- カオスエンジニアリング: {{推奨事項}}
- モニタリングとアラート: {{推奨事項}}

---

## 監視・運用方針

### 監視すべきメトリクス

#### アプリケーション層
- エラー発生率
- レスポンスタイム
- トランザクション成功率

#### データ管理層
- データベース接続プール使用率
- クエリ実行時間
- デッドロック発生回数

#### ネットワーク通信層
- API呼び出し成功率
- タイムアウト発生回数
- リトライ回数

#### 非同期処理層
- ジョブキュー長
- ジョブ処理時間
- デッドレター数

### アラート設定の推奨

| メトリクス | Warning閾値 | Critical閾値 |
|----------|-----------|------------|
| エラー率 | {{閾値}} | {{閾値}} |
| レスポンスタイム | {{閾値}} | {{閾値}} |
| データベース接続率 | {{閾値}} | {{閾値}} |
| ジョブキュー長 | {{閾値}} | {{閾値}} |

### インシデント対応プロセス

1. **検知**: {{検知方法}}
2. **トリアージ**: {{優先順位判定基準}}
3. **対応**: {{対応フロー}}
4. **復旧**: {{復旧手順}}
5. **事後分析**: {{振り返りプロセス}}

---

## 実装タイムライン

### Phase 0: 緊急対応（Week 1）
- [ ] P0-1: {{エッジケース名}} - {{担当者}}
- [ ] P0-2: {{エッジケース名}} - {{担当者}}
- [ ] P0-3: {{エッジケース名}} - {{担当者}}

### Phase 1: 高優先度対応（Week 2-3）
- [ ] P1-1: {{エッジケース名}} - {{担当者}}
- [ ] P1-2: {{エッジケース名}} - {{担当者}}

### Phase 2: 中優先度対応（Week 4-5）
- [ ] P2-1: {{エッジケース名}} - {{担当者}}
- [ ] P2-2: {{エッジケース名}} - {{担当者}}

### Phase 3: 監視体制構築（Week 6）
- [ ] モニタリング設定
- [ ] アラート設定
- [ ] ダッシュボード作成

---

## リスクと課題

### 残存リスク

#### リスク1: {{リスク内容}}
- **発生確率**: 高/中/低
- **影響度**: 高/中/低
- **軽減策**: {{軽減策}}

#### リスク2: {{リスク内容}}
（同様の形式で記載）

### 技術的負債

1. **{{負債項目}}**
   - 詳細: {{詳細}}
   - 影響: {{影響}}
   - 解消計画: {{計画}}

### 未解決の課題

1. **{{課題}}**
   - 詳細: {{詳細}}
   - 対応方針: {{方針}}

---

## 推奨事項

### 開発チームへ

1. {{推奨事項1}}
2. {{推奨事項2}}
3. {{推奨事項3}}

### QAチームへ

1. {{推奨事項1}}
2. {{推奨事項2}}

### DevOpsチームへ

1. {{推奨事項1}}
2. {{推奨事項2}}

### プロダクトオーナーへ

1. {{推奨事項1}}
2. {{推奨事項2}}

---

## 付録

### 用語集

- **エッジケース**: {{定義}}
- **リスクレベル**: {{定義}}
- **発生可能性**: {{定義}}
- **影響度**: {{定義}}

### 参考資料

- 分析モードが "requirements-based" の場合:
  - [要件定義書](../../spec/{{分析対象名}}/requirements.md)
  - [設計文書](../../spec/{{分析対象名}}/design.md)
- 分析モードが "source-based" の場合:
  - 分析対象のソースコードファイル（初期分析で特定されたファイル参照）

### 分析ファイル一覧

#### 初期分析
1. [初期分析](./initial_analysis.md)

#### レイヤー別分析
2. [アプリケーション層](./layer_analysis_app.md)
3. [UI層](./layer_analysis_ui.md)
4. [データ管理層](./layer_analysis_data.md)
5. [ネットワーク通信層](./layer_analysis_network.md)
6. [非同期処理層](./layer_analysis_async.md)
7. [認証・認可層](./layer_analysis_auth.md)
8. [レイヤー別サマリー](./layer_analysis_summary.md)

#### 複合エッジケース分析
9. [データモデル状態組み合わせ](./combined_analysis_data_state.md)
10. [複数レイヤー](./combined_analysis_multi_layer.md)
11. [カスケード障害](./combined_analysis_cascade.md)
12. [タイミング依存](./combined_analysis_timing.md)
13. [複合分析サマリー](./combined_analysis_summary.md)

---

## 結論

{{分析全体の結論を2-3段落でまとめる}}

**主要な発見**:
- {{発見1}}
- {{発見2}}
- {{発見3}}

**推奨されるアクション**:
1. {{アクション1}}
2. {{アクション2}}
3. {{アクション3}}

**リリース判定**:
{{P0対応完了を条件にリリース可能、などの判定}}

---

**分析完了日**: {{日付}}
**分析者**: Claude Code
**レビュー状況**: ⏳ レビュー待ち

---

*このレポートは自動生成されたものです。内容についてはチームでレビューしてください。*
```
</final_report_template>
